from juicechain.core.vulnerability import InputPoint, check_reflected_xss, check_sqli_error
from juicechain.core.http_client import HttpResponse


class FakeClient:
    def __init__(self, html_echo_param: str = "q"):
        self.html_echo_param = html_echo_param

    def request(self, method, url, **kwargs):
        params = kwargs.get("params") or {}
        json_data = kwargs.get("json_data") or {}
        headers = {"Content-Type": "text/html; charset=utf-8"}

        # Simulate an HTML echo endpoint for XSS check
        if method == "GET" and self.html_echo_param in params:
            payload = params[self.html_echo_param]
            body = f"<html><body>echo:{payload}</body></html>".encode("utf-8")
            return HttpResponse(ok=True, url=url, status_code=200, headers=headers, body=body, response_time_ms=5, error=None)

        # Simulate a SQL error for login JSON
        if method == "POST" and isinstance(json_data, dict) and "email" in json_data:
            if "'" in str(json_data.get("email")):
                body = b'{"error":"SQLITE_ERROR: near \\"\\": syntax error"}'
                return HttpResponse(ok=True, url=url, status_code=500, headers={"Content-Type": "application/json"}, body=body, response_time_ms=5, error=None)

        return HttpResponse(ok=True, url=url, status_code=200, headers={"Content-Type": "application/json"}, body=b"{}", response_time_ms=5, error=None)

    def close(self):
        return None


def test_check_reflected_xss_flags_html_literal_reflection():
    pt = InputPoint(method="GET", path="/echo", location="query", param="q")
    client = FakeClient(html_echo_param="q")

    f = check_reflected_xss(base="http://example.test", pt=pt, client=client, timeout=1.0, max_bytes=50_000)
    assert f is not None
    assert f.type == "XSS_REFLECTED"


def test_check_sqli_error_flags_sql_error_keywords_for_json_login():
    # group includes email/password so builder can fill both
    pts = [
        InputPoint(method="POST", path="/rest/user/login", location="json", param="email"),
        InputPoint(method="POST", path="/rest/user/login", location="json", param="password"),
    ]
    group = {("POST", "/rest/user/login"): pts}

    client = FakeClient()
    f = check_sqli_error(
        base="http://example.test",
        pt=pts[0],
        client=client,
        timeout=1.0,
        max_bytes=50_000,
        json_field_group=group,
    )
    assert f is not None
    assert f.type == "SQLI_ERROR"