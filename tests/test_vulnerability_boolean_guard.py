from juicechain.core.vulnerability import InputPoint, check_sqli_boolean
from juicechain.core.http_client import HttpResponse


class FakeClient500:
    def request(self, method, url, **kwargs):
        params = kwargs.get("params") or {}
        q = params.get("q", "")

        # baseline 正常 200 JSON
        if q.startswith("jc_"):
            body = b'{"data":[]}'
            return HttpResponse(
                ok=True, url=url, status_code=200,
                headers={"Content-Type": "application/json"},
                body=body, response_time_ms=5, error=None
            )

        # injected 触发 500 HTML 错误页（boolean 必须不报）
        if "OR 1=1" in q:
            body = b"<html><title>error</title></html>"
            return HttpResponse(
                ok=True, url=url, status_code=500,
                headers={"Content-Type": "text/html; charset=utf-8"},
                body=body, response_time_ms=5, error=None
            )

        return HttpResponse(
            ok=True, url=url, status_code=200,
            headers={"Content-Type": "application/json"},
            body=b'{"data":[]}', response_time_ms=5, error=None
        )


def test_boolean_sqli_skips_on_error_status_or_non_json():
    pt = InputPoint(method="GET", path="/rest/products/search", location="query", param="q")
    f = check_sqli_boolean(base="http://example.test", pt=pt, client=FakeClient500(), timeout=1.0, max_bytes=50_000)
    assert f is None