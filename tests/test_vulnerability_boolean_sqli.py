from juicechain.core.vulnerability import InputPoint, check_sqli_boolean
from juicechain.core.http_client import HttpResponse


class FakeClient:
    def request(self, method, url, **kwargs):
        params = kwargs.get("params") or {}
        q = params.get("q", "")

        # baseline token -> empty data
        if q.startswith("jc_"):
            body = b'{"data":[]}'
            return HttpResponse(ok=True, url=url, status_code=200, headers={"Content-Type": "application/json"}, body=body, response_time_ms=5, error=None)

        # injection -> many items
        if "OR 1=1" in q:
            body = b'{"data":[1,2,3,4,5,6,7,8,9,10]}'
            return HttpResponse(ok=True, url=url, status_code=200, headers={"Content-Type": "application/json"}, body=body, response_time_ms=5, error=None)

        return HttpResponse(ok=True, url=url, status_code=200, headers={"Content-Type": "application/json"}, body=b'{"data":[]}', response_time_ms=5, error=None)


def test_check_sqli_boolean_flags_count_change():
    pt = InputPoint(method="GET", path="/rest/products/search", location="query", param="q")
    f = check_sqli_boolean(base="http://example.test", pt=pt, client=FakeClient(), timeout=1.0, max_bytes=50_000)
    assert f is not None
    assert f.type == "SQLI_BOOLEAN"