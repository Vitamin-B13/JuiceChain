from juicechain.core.vulnerability import derive_input_points_from_scan


def test_derive_input_points_from_min_scan_doc():
    doc = {
        "target": "127.0.0.1:3000",
        "alive": {"target": "http://127.0.0.1:3000"},
        "enum": {
            "crawler": {
                "spa": {
                    "api_candidates_from_assets": [
                        "/rest/user/security-question?email=",
                        "/rest/user/change-password?current=",
                        "/rest/user/login",
                        "/api/Challenges/?key=nftMintChallenge",
                    ]
                }
            }
        },
    }

    pts = derive_input_points_from_scan(doc)
    keys = {(p.method, p.path, p.location, p.param) for p in pts}

    assert ("GET", "/rest/user/security-question", "query", "email") in keys
    assert ("GET", "/rest/user/change-password", "query", "current") in keys
    assert ("POST", "/rest/user/login", "json", "email") in keys
    assert ("POST", "/rest/user/login", "json", "password") in keys
    assert ("GET", "/api/Challenges/", "query", "key") in keys


def test_derive_input_points_handles_missing_fields():
    doc = {"target": "127.0.0.1:3000"}
    pts = derive_input_points_from_scan(doc)
    keys = {(p.method, p.path, p.location, p.param) for p in pts}

    # 即使缺少 enum/crawler 字段，也应该至少包含内置的高价值输入点
    assert ("GET", "/rest/products/search", "query", "q") in keys

    # 目前缺字段时只会产出这个 builtin（如果你后面新增更多 builtin，这行可以删掉或放宽）
    assert len(keys) == 1